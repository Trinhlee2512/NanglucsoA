<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Supermarket Optimizer - M/M/1 Queue Model</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .gradient-bg { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); }
    </style>
</head>
<body class="text-slate-800">
    <!-- Header -->
    <header class="gradient-bg text-white py-8 px-6 shadow-lg">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold flex items-center gap-3">
                    <i class="fas fa-microchip text-blue-400"></i>
                    AI Supermarket Simulator (M/M/1)
                </h1>
                <p class="text-slate-300 mt-2">Giải pháp tối ưu hóa hàng đợi dựa trên lý thuyết xác suất và toán học chuyên sâu</p>
            </div>
            <div class="mt-4 md:mt-0 flex gap-4">
                <div class="bg-emerald-500/20 border border-emerald-500/30 rounded-lg px-4 py-2 text-sm text-emerald-300">
                    <i class="fas fa-check-circle"></i> Đơn vị: Khách hàng / Phút
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Panel: Input Parameters -->
            <div class="lg:col-span-1 space-y-6">
                <section class="glass-card rounded-2xl p-6 shadow-xl border-t-4 border-blue-600">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-slate-800">
                        <i class="fas fa-sliders-h text-blue-600"></i> Thiết lập Tham số
                    </h2>
                    
                    <div class="space-y-6">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wider">
                                λ (Tốc độ khách đến / phút)
                            </label>
                            <div class="relative">
                                <input type="number" id="lambdaInput" step="0.01" class="w-full p-4 bg-white border border-slate-300 rounded-xl font-bold text-2xl text-blue-700 focus:ring-4 focus:ring-blue-100 outline-none transition-all" value="0.40">
                                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">λ</span>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2 italic">* Số lượng khách hàng trung bình đến trong 1 phút</p>
                        </div>

                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wider">
                                μ (Khả năng phục vụ / phút)
                            </label>
                            <div class="relative">
                                <input type="number" id="muInput" step="0.01" class="w-full p-4 bg-white border border-slate-300 rounded-xl font-bold text-2xl text-emerald-700 focus:ring-4 focus:ring-emerald-100 outline-none transition-all" value="0.60">
                                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">μ</span>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2 italic">* Số lượng khách hàng tối đa quầy có thể xử lý trong 1 phút</p>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-200">
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-sm font-medium text-slate-600">Hiệu suất hệ thống (ρ):</span>
                            <span id="rhoValue" class="font-black text-2xl text-blue-600">0.67</span>
                        </div>
                        <div class="w-full bg-slate-200 h-3 rounded-full overflow-hidden shadow-inner">
                            <div id="rhoBar" class="bg-blue-500 h-full transition-all duration-500" style="width: 67%"></div>
                        </div>
                        <p id="rhoStatus" class="text-center text-xs mt-3 font-semibold text-emerald-600">Hệ thống đang hoạt động ổn định</p>
                    </div>
                </section>

                <section class="glass-card rounded-2xl p-6 shadow-sm border border-slate-200 bg-slate-50/50">
                    <h2 class="text-sm font-bold text-slate-700 mb-3 uppercase flex items-center gap-2">
                        <i class="fas fa-magic text-purple-600"></i> AI Estimator (Nâng cao)
                    </h2>
                    <p class="text-[11px] text-slate-500 mb-4 leading-relaxed">Nếu bạn có dữ liệu thô, hãy dán vào đây để AI tự động trích xuất λ và μ.</p>
                    <textarea id="rawLogs" class="w-full h-24 p-3 text-xs font-mono border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 mb-3" placeholder="Time, ServiceSeconds..."></textarea>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="generateSampleData()" class="text-xs py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition-colors">Dữ liệu mẫu</button>
                        <button onclick="estimateParameters()" class="text-xs py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">AI Ước lượng</button>
                    </div>
                </section>
            </div>

            <!-- Right Panel: Results & Visualization -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Metrics Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="glass-card p-4 rounded-2xl border-l-4 border-blue-600 shadow-lg transform hover:scale-105 transition-transform">
                        <p class="text-xs text-slate-400 uppercase font-black">Khách trong HT (L)</p>
                        <p id="metricL" class="text-3xl font-black text-slate-800">2.00</p>
                        <p class="text-[10px] text-blue-500 font-bold">Khách hàng</p>
                    </div>
                    <div class="glass-card p-4 rounded-2xl border-l-4 border-indigo-500 shadow-lg transform hover:scale-105 transition-transform">
                        <p class="text-xs text-slate-400 uppercase font-black">Đang chờ (Lq)</p>
                        <p id="metricLq" class="text-3xl font-black text-slate-800">1.33</p>
                        <p class="text-[10px] text-indigo-500 font-bold">Khách hàng</p>
                    </div>
                    <div class="glass-card p-4 rounded-2xl border-l-4 border-emerald-500 shadow-lg transform hover:scale-105 transition-transform">
                        <p class="text-xs text-slate-400 uppercase font-black">Thời gian HT (W)</p>
                        <p id="metricW" class="text-3xl font-black text-slate-800">5.00</p>
                        <p class="text-[10px] text-emerald-500 font-bold">Phút / Khách</p>
                    </div>
                    <div class="glass-card p-4 rounded-2xl border-l-4 border-amber-500 shadow-lg transform hover:scale-105 transition-transform">
                        <p class="text-xs text-slate-400 uppercase font-black">Thời gian chờ (Wq)</p>
                        <p id="metricWq" class="text-3xl font-black text-slate-800">3.33</p>
                        <p class="text-[10px] text-amber-500 font-bold">Phút / Khách</p>
                    </div>
                </div>

                <!-- Chart & AI Analysis -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card rounded-2xl p-6 shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold mb-4">Phân phối trạng thái Pn</h3>
                        <canvas id="stateChart" height="200"></canvas>
                    </div>
                    <div class="glass-card rounded-2xl p-6 shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                            <i class="fas fa-lightbulb text-amber-500"></i> AI Optimization Insight
                        </h3>
                        <div id="aiAdvice" class="space-y-3 text-sm text-slate-600">
                            <!-- AI Advice injected here -->
                            <p>Phân tích hệ thống đang được tải...</p>
                        </div>
                    </div>
                </div>

                <!-- Simulation Visual -->
                <div class="glass-card rounded-2xl p-6 shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold mb-4">Mô phỏng hàng đợi thời gian thực</h3>
                    <div class="bg-slate-900 rounded-xl p-8 relative overflow-hidden min-h-[200px] flex items-center justify-end">
                        <div class="absolute left-10 top-1/2 -translate-y-1/2 w-24 h-24 border-4 border-blue-500 rounded-lg flex items-center justify-center bg-blue-900/20">
                            <i class="fas fa-cash-register text-3xl text-blue-400"></i>
                        </div>
                        <div id="queueSim" class="flex gap-2 items-center pr-4 overflow-x-auto max-w-[70%]">
                            <!-- Visual customers here -->
                        </div>
                        <div class="absolute bottom-4 left-10 text-xs text-slate-400">QUẦY PHỤC VỤ</div>
                        <div class="absolute bottom-4 right-10 text-xs text-slate-400">KHÁCH ĐANG ĐẾN →</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-12 py-8 border-t border-slate-200 text-center text-slate-500 text-sm">
        <p>© 2024 AI Supermarket Math Solutions. Advanced Queueing Theory Module.</p>
    </footer>

    <script>
        let stateChart;

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            calculate();
            
            // Listeners
            document.getElementById('lambdaInput').addEventListener('input', calculate);
            document.getElementById('muInput').addEventListener('input', calculate);
        });

        function generateSampleData() {
            const now = new Date();
            let logs = "";
            let currentTime = new Date(now.setHours(8, 0, 0));
            
            for(let i=0; i<30; i++) {
                // Giả định λ = 0.4 khách/phút (khoảng 2.5 phút có 1 khách)
                const interval = Math.floor(Math.random() * 4) + 1; 
                // Giả định μ = 0.6 khách/phút (khoảng 100s phục vụ 1 khách)
                const service = Math.floor(Math.random() * 120) + 40; 
                currentTime = new Date(currentTime.getTime() + interval * 60000);
                const timeStr = currentTime.getHours().toString().padStart(2, '0') + ":" + currentTime.getMinutes().toString().padStart(2, '0');
                logs += `${timeStr}, ${service}\n`;
            }
            document.getElementById('rawLogs').value = logs.trim();
        }

        function estimateParameters() {
            const logs = document.getElementById('rawLogs').value.trim();
            if(!logs) return alert("Vui lòng nhập dữ liệu log!");

            const lines = logs.split('\n');
            let totalServiceTimeSeconds = 0;
            let arrivalTimes = [];

            lines.forEach(line => {
                const parts = line.split(',');
                if(parts.length >= 2) {
                    const time = parts[0].trim();
                    const service = parts[1].trim();
                    const [h, m] = time.split(':').map(Number);
                    arrivalTimes.push(h * 60 + m);
                    totalServiceTimeSeconds += parseFloat(service);
                }
            });

            if(arrivalTimes.length < 2) return alert("Cần ít nhất 2 dòng dữ liệu!");

            // Tính Lambda (Khách/Phút)
            // λ = Tổng số khách / Tổng thời gian quan sát (phút)
            const durationMinutes = arrivalTimes[arrivalTimes.length - 1] - arrivalTimes[0];
            const lambda = arrivalTimes.length / durationMinutes;

            // Tính Mu (Khách/Phút)
            // μ = 1 / (Thời gian phục vụ trung bình tính bằng phút)
            const avgServiceMinutes = (totalServiceTimeSeconds / lines.length) / 60;
            const mu = 1 / avgServiceMinutes;

            document.getElementById('lambdaInput').value = lambda.toFixed(3);
            document.getElementById('muInput').value = mu.toFixed(3);
            
            calculate();
        }

        function calculate() {
            const lambda = parseFloat(document.getElementById('lambdaInput').value);
            const mu = parseFloat(document.getElementById('muInput').value);
            const rhoStatus = document.getElementById('rhoStatus');
            
            if (isNaN(lambda) || isNaN(mu) || mu <= 0) return;

            const rho = lambda / mu;
            document.getElementById('rhoValue').innerText = rho.toFixed(2);
            const rhoBar = document.getElementById('rhoBar');
            rhoBar.style.width = Math.min(rho * 100, 100) + '%';
            
            if (rho >= 1) {
                rhoBar.classList.remove('bg-blue-500', 'bg-amber-500');
                rhoBar.classList.add('bg-red-500');
                rhoStatus.innerText = "Hệ thống BẤT ỔN (λ ≥ μ)";
                rhoStatus.className = "text-center text-xs mt-3 font-bold text-red-600 animate-pulse";
                updateMetrics(true);
                updateAdvice(rho, true, 0, 0, lambda);
                updateChart(0.99); // Kịch bản tới hạn cho biểu đồ
                updateSim(20);
                return;
            } else {
                if (rho > 0.8) {
                    rhoBar.classList.remove('bg-blue-500', 'bg-red-500');
                    rhoBar.classList.add('bg-amber-500');
                    rhoStatus.innerText = "Hệ thống đang quá tải nặng";
                    rhoStatus.className = "text-center text-xs mt-3 font-bold text-amber-600";
                } else {
                    rhoBar.classList.remove('bg-red-500', 'bg-amber-500');
                    rhoBar.classList.add('bg-blue-500');
                    rhoStatus.innerText = "H hệ thống đang hoạt động ổn định";
                    rhoStatus.className = "text-center text-xs mt-3 font-bold text-emerald-600";
                }
            }

            // M/M/1 Mathematical Formulas (Đơn vị: Phút)
            const L = rho / (1 - rho); 
            const Lq = (rho * rho) / (1 - rho);
            const W = 1 / (mu - lambda);
            const Wq = lambda / (mu * (mu - lambda));

            updateMetrics(false, L, Lq, W, Wq);
            updateChart(rho);
            updateAdvice(rho, false, L, Wq, lambda);
            updateSim(Math.round(L));
        }

        function updateMetrics(isUnstable, L, Lq, W, Wq) {
            if (isUnstable) {
                ['metricL', 'metricLq', 'metricW', 'metricWq'].forEach(id => {
                    document.getElementById(id).innerText = "∞";
                    document.getElementById(id).classList.add('text-red-600');
                });
                return;
            }

            document.getElementById('metricL').innerText = L.toFixed(2);
            document.getElementById('metricLq').innerText = Lq.toFixed(2);
            document.getElementById('metricW').innerText = W.toFixed(2);
            document.getElementById('metricWq').innerText = Wq.toFixed(2);
            
            ['metricL', 'metricLq', 'metricW', 'metricWq'].forEach(id => {
                document.getElementById(id).classList.remove('text-red-600');
            });
        }

        function updateAdvice(rho, isUnstable, L, Wq, lambda) {
            const adviceBox = document.getElementById('aiAdvice');
            let html = "";

            if (isUnstable) {
                html = `
                    <div class="p-4 bg-red-100 text-red-800 border-l-4 border-red-600 rounded-r-lg shadow-sm">
                        <h4 class="font-bold flex items-center gap-2 mb-1">
                            <i class="fas fa-exclamation-triangle"></i> CẢNH BÁO BẤT ỔN
                        </h4>
                        <p class="text-xs leading-relaxed">
                            Tốc độ đến <strong>${lambda.toFixed(2)}</strong> ≥ Khả năng phục vụ. Hàng đợi sẽ tích tụ vô hạn.
                            <br><strong>Giải pháp:</strong> Cần tăng μ lên ít nhất <strong>${(lambda * 1.2).toFixed(2)}</strong> khách/phút.
                        </p>
                    </div>
                `;
            } else {
                if (rho > 0.8) {
                    html = `
                        <div class="p-4 bg-amber-100 text-amber-800 border-l-4 border-amber-600 rounded-r-lg shadow-sm">
                            <h4 class="font-bold flex items-center gap-2 mb-1">
                                <i class="fas fa-tachometer-alt"></i> QUÁ TẢI VẬN HÀNH
                            </h4>
                            <p class="text-xs leading-relaxed">
                                Hiệu suất đạt ${(rho*100).toFixed(1)}%. Khách phải chờ trung bình <strong>${Wq.toFixed(2)}</strong> phút.
                                <br><strong>AI đề xuất:</strong> Mở thêm quầy phụ hoặc nâng cấp quy trình quét mã để tăng μ.
                            </p>
                        </div>
                    `;
                } else if (rho < 0.3) {
                    html = `
                        <div class="p-4 bg-emerald-100 text-emerald-800 border-l-4 border-emerald-600 rounded-r-lg shadow-sm">
                            <h4 class="font-bold flex items-center gap-2 mb-1">
                                <i class="fas fa-leaf"></i> DƯ THỪA CÔNG SUẤT
                            </h4>
                            <p class="text-xs leading-relaxed">
                                Hiệu suất thấp (${(rho*100).toFixed(1)}%). Nhân viên đang rảnh rỗi quá nhiều.
                                <br><strong>Tối ưu:</strong> Có thể tạm thời đóng quầy này để tiết kiệm chi phí nhân công.
                            </p>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="p-4 bg-blue-100 text-blue-800 border-l-4 border-blue-600 rounded-r-lg shadow-sm">
                            <h4 class="font-bold flex items-center gap-2 mb-1">
                                <i class="fas fa-check-circle"></i> TRẠNG THÁI LÝ TƯỞNG
                            </h4>
                            <p class="text-xs leading-relaxed">
                                Hệ thống cân bằng tuyệt vời ở mức ${(rho*100).toFixed(1)}%. Khách hài lòng và chi phí tối ưu.
                            </p>
                        </div>
                    `;
                }
            }
            adviceBox.innerHTML = html;
        }

        function initChart() {
            const ctx = document.getElementById('stateChart').getContext('2d');
            stateChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0', '1', '2', '3', '4', '5+'],
                    datasets: [{
                        label: 'Xác suất Pn (Có n khách)',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, max: 1 } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateChart(rho) {
            const probs = [];
            let sumP = 0;
            for(let n=0; n<5; n++) {
                const pn = (1 - rho) * Math.pow(rho, n);
                probs.push(pn);
                sumP += pn;
            }
            probs.push(1 - sumP); // P(n >= 5)

            stateChart.data.datasets[0].data = probs;
            stateChart.update();
        }

        function updateSim(count) {
            const container = document.getElementById('queueSim');
            container.innerHTML = "";
            const displayCount = Math.min(count, 12);
            
            for(let i=0; i<displayCount; i++) {
                const user = document.createElement('div');
                user.className = "w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-white border-2 border-slate-600 shrink-0 animate-bounce";
                user.style.animationDelay = (i * 0.1) + "s";
                user.innerHTML = `<i class="fas fa-user text-xs"></i>`;
                container.appendChild(user);
            }
            
            if(count > 12) {
                const more = document.createElement('div');
                more.className = "text-slate-400 font-bold ml-2";
                more.innerText = `+${count - 12}`;
                container.appendChild(more);
            }
        }
    </script>
</body>
</html>
